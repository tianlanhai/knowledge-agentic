#!/bin/bash
# ============================================================================
# 知识库智能体 - 版本配置函数库
# File    : lib/version.sh
# Purpose : 提供版本相关的配置和验证函数
# ============================================================================

# ============================================================================
# 版本配置数组
# ============================================================================
declare -A VERSION_DESCRIPTIONS=(
    ["v1"]="云LLM + 本地向量（约3.5GB，需要torch）"
    ["v2"]="云LLM + 云端向量（约800MB，轻量版）"
    ["v3"]="本地LLM + 本地向量（约3.5GB，需要torch）"
    ["v4"]="本地LLM + 云端向量（约800MB，轻量版）"
)

declare -A INSTALL_LOCAL_EMB_MAP=(
    ["v1"]="true"
    ["v2"]="false"
    ["v3"]="true"
    ["v4"]="false"
)

# ============================================================================
# version_validate - 验证版本号是否有效
# 参数: $1 = 版本号 (v1/v2/v3/v4)
# 返回: 0=有效, 1=无效
# ============================================================================
version_validate() {
    local ver="$1"
    if [[ ! "$ver" =~ ^v[1-4]$ ]]; then
        return 1
    fi
    return 0
}

# ============================================================================
# version_get_description - 获取版本描述
# 参数: $1 = 版本号
# 返回: 输出版本描述
# ============================================================================
version_get_description() {
    local ver="$1"
    echo "${VERSION_DESCRIPTIONS[$ver]}"
}

# ============================================================================
# version_get_config - 获取版本配置信息
# 参数: $1 = 版本号
# 输出: 可eval的配置变量赋值语句
# ============================================================================
version_get_config() {
    local ver="$1"
    local registry="${REGISTRY:-registry.cn-shanghai.aliyuncs.com/tianlanhai/test}"
    local image_name="${IMAGE_NAME:-knowagent-back}"

    cat <<EOF
VERSION="$ver"
VERSION_DESC="${VERSION_DESCRIPTIONS[$ver]}"
INSTALL_LOCAL_EMB="${INSTALL_LOCAL_EMB_MAP[$ver]}"
IMAGE_TAG="${registry}:${image_name}-${ver}"
EOF
}

# ============================================================================
# version_list - 列出所有可用版本
# ============================================================================
version_list() {
    echo "可用版本列表:"
    echo "  v1 - ${VERSION_DESCRIPTIONS[v1]}"
    echo "  v2 - ${VERSION_DESCRIPTIONS[v2]}"
    echo "  v3 - ${VERSION_DESCRIPTIONS[v3]}"
    echo "  v4 - ${VERSION_DESCRIPTIONS[v4]}"
}

# ============================================================================
# End of file
# ============================================================================
